#!/usr/bin/env bash
# --------------------------------------------------------------#
# Restrict specific branches to be merged into any other branch #
# --------------------------------------------------------------#
# Muhammed Salman Shamsi <muhammed-salman@users.noreply.github.com>

# Step 1:
# Put this file in your local repo, in the .git/hooks folder 
#                       or 
# place it another folder in your repo if you want to commit it & create a symlink like `ln -s ../../prepare-commit-msg.sh .git/hooks/prepare-commit-msg`
# Step 2:
# Make sure it is executable. `chmod +x .git/hooks/prepare-commit-msg`
# The name of the file *must* be "prepare-commit-msg" for Git to pick it up.

RESTRICTED_BRANCHES=("staging")

# Check for merges
if [[ $2 != 'merge' ]]; then
    # Not a merge
    exit 0
fi

# Current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Merging from
FROM_BRANCH=$(head -n 1 $1 | sed -e "s/^\s*Merge .*\?branch '\(.*\?\)'.*$/\1/")
echo "From Branch: ${FROM_BRANCH}
Current Branch: ${CURRENT_BRANCH}"

if [[ ! " ${RESTRICTED_BRANCHES[*]} " =~ " ${FROM_BRANCH} " ]]; then
    exit 0
fi


echo "[POLICY] Forbidden cross merge"
echo "         You are trying to merge from a restricted branch ${FROM_BRANCH} into ${CURRENT_BRANCH} branch."
echo "         You cannot merge any of ${RESTRICTED_BRANCHES[*]} branches into any of the branch."
echo "         The operation has been aborted."
echo
echo "         The merged content has been removed from your staging and working directories."
echo "         Please run the below command to reset merge head:"
echo "         - abort the operation"
echo "           git merge --abort"
echo
echo "The below message is generated by git and is highly discouraged"

git merge --abort

exit 1
